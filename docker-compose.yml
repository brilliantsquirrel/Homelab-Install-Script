services:
  # Nginx reverse proxy with authentication
  nginx:
    build:
      context: ./nginx
      dockerfile: Dockerfile
    container_name: nginx-proxy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - nginx_certs:/etc/nginx/certs
      - nginx_auth:/etc/nginx/auth
    depends_on:
      - ollama
      - openwebui
      - qdrant
      - portainer
      - langchain
      - langgraph
      - langflow
      - n8n
      - homarr
      - hoarder
      - plex
      - comfyui
      - nextcloud
      - pihole
      - code-server
    networks:
      - homelab_network
    environment:
      - TZ=UTC

  # Docker Socket Proxy - Restricts Portainer's access to Docker API
  # This prevents full system compromise if Portainer is compromised
  docker-socket-proxy:
    image: tecnativa/docker-socket-proxy:latest
    container_name: docker-socket-proxy
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      - TZ=UTC
      # Restrict access to only necessary Docker API endpoints
      - CONTAINERS=1        # View containers
      - SERVICES=1          # View services
      - TASKS=1            # View tasks
      - NETWORKS=1         # View networks
      - IMAGES=0           # No image access
      - AUTH=0             # No auth endpoints
      - EXEC=0             # No exec access
      - POST=0             # No write operations by default
      - ALLOW_START=0      # No container start
      - ALLOW_STOP=0       # No container stop
      - ALLOW_RESTART=0    # No container restart
    networks:
      - homelab_network
    # Socket proxy doesn't need to be exposed to ports
    expose:
      - "2375"

  portainer:
    image: portainer/portainer-ce:2.20.0
    container_name: portainer
    restart: unless-stopped
    # Security: Use docker-socket-proxy instead of direct socket access
    # This limits Portainer's access to only viewing containers/services
    # preventing full system compromise if Portainer is compromised
    depends_on:
      - docker-socket-proxy
    volumes:
      - portainer_data:/data
    environment:
      - TZ=UTC
      # Connect to socket proxy instead of docker.sock directly
      - DOCKER_HOST=tcp://docker-socket-proxy:2375
    networks:
      - homelab_network

  ollama:
    # Using 0.12.9 for qwen3-vl:8b support (Nov 2025 release)
    image: ollama/ollama:0.12.9
    container_name: ollama
    restart: unless-stopped
    volumes:
      - ollama_data:/root/.ollama
    environment:
      - TZ=UTC
      - OLLAMA_API_KEY=${OLLAMA_API_KEY:?OLLAMA_API_KEY environment variable is required}
    # Uncomment the following line for GPU support (NVIDIA CUDA)
    # runtime: nvidia
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: 1
    #           capabilities: [gpu]
    # Security: Use 'expose' instead of 'ports' - only accessible via nginx reverse proxy
    # Access through: https://<server-ip>/ollama (authenticated)
    expose:
      - "11434"
    networks:
      - homelab_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:11434/api/tags"]
      interval: 30s
      timeout: 10s
      retries: 3

  openwebui:
    image: ghcr.io/open-webui/open-webui:v0.3.0
    container_name: openwebui
    restart: unless-stopped
    volumes:
      - openwebui_data:/app/backend/data
    environment:
      - OLLAMA_BASE_URL=http://ollama:11434
      - OLLAMA_API_KEY=${OLLAMA_API_KEY:?OLLAMA_API_KEY environment variable is required}
      - TZ=UTC
      - WEBUI_SECRET_KEY=${WEBUI_SECRET_KEY:?WEBUI_SECRET_KEY environment variable is required}
    depends_on:
      - ollama
    networks:
      - homelab_network

  langchain:
    image: langchain/langchain:0.1.0
    container_name: langchain
    restart: unless-stopped
    environment:
      - OLLAMA_BASE_URL=http://ollama:11434
      - LANGCHAIN_API_KEY=${LANGCHAIN_API_KEY:?LANGCHAIN_API_KEY environment variable is required}
      - TZ=UTC
    depends_on:
      - ollama
    networks:
      - homelab_network

  langflow:
    image: langflowai/langflow:1.0.0
    container_name: langflow
    restart: unless-stopped
    volumes:
      - langflow_data:/root/.langflow
    environment:
      - OLLAMA_BASE_URL=http://ollama:11434
      - LANGFLOW_API_KEY=${LANGFLOW_API_KEY:?LANGFLOW_API_KEY environment variable is required}
      - TZ=UTC
    depends_on:
      - ollama
    networks:
      - homelab_network

  # LangGraph - Stateful agent workflow engine
  langgraph-redis:
    image: redis:7-alpine
    container_name: langgraph-redis
    restart: unless-stopped
    environment:
      - TZ=UTC
    networks:
      - homelab_network

  langgraph-db:
    image: postgres:16-alpine
    container_name: langgraph-db
    restart: unless-stopped
    volumes:
      - langgraph_db:/var/lib/postgresql/data
    environment:
      - TZ=UTC
      - POSTGRES_DB=langgraph
      - POSTGRES_USER=langgraph
      - POSTGRES_PASSWORD=${LANGGRAPH_DB_PASSWORD:?LANGGRAPH_DB_PASSWORD environment variable is required}
    networks:
      - homelab_network

  langgraph:
    image: langchain/langgraph-api:3.11
    container_name: langgraph
    restart: unless-stopped
    environment:
      - TZ=UTC
      - REDIS_URI=redis://langgraph-redis:6379
      - POSTGRES_URI=postgres://langgraph:${LANGGRAPH_DB_PASSWORD:?LANGGRAPH_DB_PASSWORD environment variable is required}@langgraph-db:5432/langgraph
      - LANGSMITH_API_KEY=${LANGGRAPH_API_KEY:?LANGGRAPH_API_KEY environment variable is required}
      - OLLAMA_BASE_URL=http://ollama:11434
    depends_on:
      - ollama
      - langgraph-redis
      - langgraph-db
    expose:
      - "8000"
    networks:
      - homelab_network

  n8n:
    image: n8nio/n8n:1.95.0
    container_name: n8n
    restart: unless-stopped
    volumes:
      - n8n_data:/home/node/.n8n
    environment:
      - N8N_PROTOCOL=http
      - N8N_HOST=0.0.0.0
      - N8N_PORT=5678
      - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY:?N8N_ENCRYPTION_KEY environment variable is required (min 32 chars)}
      - TZ=UTC
      - OLLAMA_BASE_URL=http://ollama:11434
    depends_on:
      - ollama
    networks:
      - homelab_network

  qdrant:
    image: qdrant/qdrant:v1.13.0
    container_name: qdrant
    restart: unless-stopped
    volumes:
      - qdrant_data:/qdrant/storage
      - ./qdrant_config.yaml:/qdrant/config/config.yaml:ro
    environment:
      - TZ=UTC
      - QDRANT_API_KEY=${QDRANT_API_KEY:?QDRANT_API_KEY environment variable is required}
      - QDRANT_HTTP_PORT=6333
      - QDRANT_GRPC_PORT=6334
    # Security: Use 'expose' instead of 'ports' - only accessible via nginx reverse proxy
    # Access through: https://<server-ip>/qdrant (authenticated)
    expose:
      - "6333"
      - "6334"
    healthcheck:
      # Security: Use internal health endpoint without API key to avoid exposing key in logs
      test: ["CMD", "curl", "-f", "http://localhost:6333/"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - homelab_network

  # Homarr - Homelab dashboard and service organizer
  homarr:
    image: ghcr.io/ajnart/homarr:latest
    container_name: homarr
    restart: unless-stopped
    volumes:
      - homarr_config:/app/data/configs
      - homarr_icons:/app/public/icons
      - homarr_data:/data
    environment:
      - TZ=UTC
    expose:
      - "7575"
    networks:
      - homelab_network

  # Hoarder - Self-hosted bookmark manager
  hoarder:
    image: ghcr.io/hoarder-app/hoarder:latest
    container_name: hoarder
    restart: unless-stopped
    volumes:
      - hoarder_data:/data
    environment:
      - TZ=UTC
      - HOARDER_SECRET_KEY=${HOARDER_SECRET_KEY:?HOARDER_SECRET_KEY environment variable is required}
      - NEXTAUTH_SECRET=${NEXTAUTH_SECRET:?NEXTAUTH_SECRET environment variable is required}
      - NEXTAUTH_URL=https://${SERVER_HOSTNAME:-homelab.local}/hoarder
    expose:
      - "3000"
    networks:
      - homelab_network

  # Plex - Media server
  plex:
    image: lscr.io/linuxserver/plex:latest
    container_name: plex
    restart: unless-stopped
    volumes:
      - plex_config:/config
      - plex_media:/media
      - plex_transcode:/transcode
    environment:
      - TZ=UTC
      - PUID=1000
      - PGID=1000
      - VERSION=docker
      - PLEX_CLAIM=${PLEX_CLAIM:-}
    # Uncomment the following lines for GPU transcoding (NVIDIA)
    # runtime: nvidia
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: 1
    #           capabilities: [gpu, video, compute, utility]
    expose:
      - "32400"
    # Note: Plex needs port 32400 for discovery. Uncomment if needed:
    # ports:
    #   - "32400:32400"
    networks:
      - homelab_network

  # ComfyUI - Node-based UI for Stable Diffusion and AI image generation
  comfyui:
    image: ghcr.io/ai-dock/comfyui:latest
    container_name: comfyui
    restart: unless-stopped
    volumes:
      - comfyui_data:/data
      - comfyui_models:/opt/ComfyUI/models
      - comfyui_output:/opt/ComfyUI/output
    environment:
      - TZ=UTC
      - PUID=1000
      - PGID=1000
      # Enable automatic model downloads
      - AUTO_UPDATE=true
    # Uncomment the following lines for GPU support (NVIDIA)
    # IMPORTANT: ComfyUI requires GPU for practical use
    # runtime: nvidia
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: 1
    #           capabilities: [gpu, compute, utility]
    # Security: Use 'expose' instead of 'ports' - only accessible via nginx reverse proxy
    # Access through: https://<server-ip>/comfyui (authenticated)
    expose:
      - "8188"
    networks:
      - homelab_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8188/"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Nextcloud - File storage and collaboration platform
  nextcloud-db:
    image: postgres:16-alpine
    container_name: nextcloud-db
    restart: unless-stopped
    volumes:
      - nextcloud_db:/var/lib/postgresql/data
    environment:
      - TZ=UTC
      - POSTGRES_DB=nextcloud
      - POSTGRES_USER=nextcloud
      - POSTGRES_PASSWORD=${NEXTCLOUD_DB_PASSWORD:?NEXTCLOUD_DB_PASSWORD environment variable is required}
    networks:
      - homelab_network

  nextcloud-redis:
    image: redis:7-alpine
    container_name: nextcloud-redis
    restart: unless-stopped
    environment:
      - TZ=UTC
    networks:
      - homelab_network

  nextcloud:
    image: nextcloud:29-apache
    container_name: nextcloud
    restart: unless-stopped
    volumes:
      - nextcloud_data:/var/www/html
    environment:
      - TZ=UTC
      - POSTGRES_HOST=nextcloud-db
      - POSTGRES_DB=nextcloud
      - POSTGRES_USER=nextcloud
      - POSTGRES_PASSWORD=${NEXTCLOUD_DB_PASSWORD:?NEXTCLOUD_DB_PASSWORD environment variable is required}
      - REDIS_HOST=nextcloud-redis
      - NEXTCLOUD_TRUSTED_DOMAINS=${SERVER_HOSTNAME:-homelab.local}
      - OVERWRITEPROTOCOL=https
      - OVERWRITEHOST=${SERVER_HOSTNAME:-homelab.local}
      - OVERWRITEWEBROOT=/nextcloud
    depends_on:
      - nextcloud-db
      - nextcloud-redis
    expose:
      - "80"
    networks:
      - homelab_network

  # Pi-Hole - DNS-based ad blocker
  pihole:
    image: pihole/pihole:latest
    container_name: pihole
    restart: unless-stopped
    volumes:
      - pihole_etc:/etc/pihole
      - pihole_dnsmasq:/etc/dnsmasq.d
      - ./pihole-custom-dns.conf:/etc/dnsmasq.d/02-custom-dns.conf:ro
    environment:
      - TZ=UTC
      - WEBPASSWORD=${PIHOLE_PASSWORD:?PIHOLE_PASSWORD environment variable is required}
      - VIRTUAL_HOST=${SERVER_HOSTNAME:-homelab.local}
      - PROXY_LOCATION=pihole
      - FTLCONF_LOCAL_IPV4=${SERVER_IP:-}
    # DNS ports - Pi-Hole on alternate port 5353 (change to 53 after stopping dnsmasq)
    ports:
      - "5353:53/tcp"
      - "5353:53/udp"
    # Web interface accessible via nginx reverse proxy
    expose:
      - "80"
    networks:
      - homelab_network
    dns:
      - 127.0.0.1
      - 1.1.1.1
    cap_add:
      - NET_ADMIN

  # Code-Server - VS Code in the browser
  code-server:
    image: lscr.io/linuxserver/code-server:latest
    container_name: code-server
    restart: unless-stopped
    volumes:
      - code_server_config:/config
      - code_server_workspace:/workspace
    environment:
      - TZ=UTC
      - PUID=1000
      - PGID=1000
      - PASSWORD=${CODE_SERVER_PASSWORD:?CODE_SERVER_PASSWORD environment variable is required}
      - SUDO_PASSWORD=${CODE_SERVER_SUDO_PASSWORD:-}
      - DEFAULT_WORKSPACE=/workspace
    # Security: Use 'expose' instead of 'ports' - only accessible via nginx reverse proxy
    # Access through: https://<server-ip>/code (authenticated)
    expose:
      - "8443"
    networks:
      - homelab_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8443/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  portainer_data:
    driver: local
  ollama_data:
    driver: local
  openwebui_data:
    driver: local
  langflow_data:
    driver: local
  langgraph_db:
    driver: local
  n8n_data:
    driver: local
  qdrant_data:
    driver: local
  nginx_certs:
    driver: local
  nginx_auth:
    driver: local
  homarr_config:
    driver: local
  homarr_icons:
    driver: local
  homarr_data:
    driver: local
  hoarder_data:
    driver: local
  plex_config:
    driver: local
  plex_media:
    driver: local
  plex_transcode:
    driver: local
  comfyui_data:
    driver: local
  comfyui_models:
    driver: local
  comfyui_output:
    driver: local
  nextcloud_db:
    driver: local
  nextcloud_data:
    driver: local
  pihole_etc:
    driver: local
  pihole_dnsmasq:
    driver: local
  code_server_config:
    driver: local
  code_server_workspace:
    driver: local

networks:
  homelab_network:
    driver: bridge
