<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Homelab ISO Builder</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>üè† Homelab ISO Builder</h1>
            <p class="tagline">Build your custom Ubuntu Server ISO with pre-configured homelab services</p>
        </header>

        <div id="app">
            <!-- Step 1: Service Selection -->
            <section id="step-services" class="step active">
                <h2>Step 1: Select Services</h2>
                <p class="step-description">Choose which services to include in your homelab ISO</p>

                <div class="service-categories">
                    <div class="category" id="ai-services">
                        <h3>ü§ñ AI & Machine Learning</h3>
                        <div class="service-list">
                            <label class="service-item">
                                <input type="checkbox" name="service" value="ollama" data-category="ai" data-deps="">
                                <div class="service-card">
                                    <div class="service-name">Ollama</div>
                                    <div class="service-description">Local LLM runtime with GPU support</div>
                                    <div class="service-size">~2GB</div>
                                </div>
                            </label>
                            <label class="service-item">
                                <input type="checkbox" name="service" value="openwebui" data-category="ai" data-deps="ollama">
                                <div class="service-card">
                                    <div class="service-name">OpenWebUI</div>
                                    <div class="service-description">Web interface for Ollama</div>
                                    <div class="service-size">~500MB</div>
                                </div>
                            </label>
                            <label class="service-item">
                                <input type="checkbox" name="service" value="langflow" data-category="ai" data-deps="ollama">
                                <div class="service-card">
                                    <div class="service-name">LangFlow</div>
                                    <div class="service-description">Visual AI workflow builder</div>
                                    <div class="service-size">~1.5GB</div>
                                </div>
                            </label>
                            <label class="service-item">
                                <input type="checkbox" name="service" value="langgraph" data-category="ai" data-deps="ollama,langgraph-redis,langgraph-db">
                                <div class="service-card">
                                    <div class="service-name">LangGraph</div>
                                    <div class="service-description">Stateful agent workflow engine</div>
                                    <div class="service-size">~800MB</div>
                                </div>
                            </label>
                            <label class="service-item">
                                <input type="checkbox" name="service" value="qdrant" data-category="ai" data-deps="">
                                <div class="service-card">
                                    <div class="service-name">Qdrant</div>
                                    <div class="service-description">Vector database for embeddings</div>
                                    <div class="service-size">~300MB</div>
                                </div>
                            </label>
                            <label class="service-item">
                                <input type="checkbox" name="service" value="n8n" data-category="ai" data-deps="ollama">
                                <div class="service-card">
                                    <div class="service-name">n8n</div>
                                    <div class="service-description">Workflow automation platform</div>
                                    <div class="service-size">~600MB</div>
                                </div>
                            </label>
                            <label class="service-item">
                                <input type="checkbox" name="service" value="comfyui" data-category="ai" data-deps="">
                                <div class="service-card">
                                    <div class="service-name">ComfyUI</div>
                                    <div class="service-description">Node-based UI for Stable Diffusion and AI image generation</div>
                                    <div class="service-size">~3GB</div>
                                </div>
                            </label>
                            <label class="service-item">
                                <input type="checkbox" name="service" value="huggingface" data-category="ai" data-deps="">
                                <div class="service-card">
                                    <div class="service-name">HuggingFace TGI</div>
                                    <div class="service-description">Text Generation Inference server for HuggingFace models</div>
                                    <div class="service-size">~4GB</div>
                                </div>
                            </label>
                        </div>
                    </div>

                    <div class="category" id="homelab-services">
                        <h3>üè° Homelab Services</h3>
                        <div class="service-list">
                            <label class="service-item">
                                <input type="checkbox" name="service" value="nextcloud" data-category="homelab" data-deps="nextcloud-db,nextcloud-redis">
                                <div class="service-card">
                                    <div class="service-name">Nextcloud</div>
                                    <div class="service-description">File storage & collaboration</div>
                                    <div class="service-size">~1.2GB</div>
                                </div>
                            </label>
                            <label class="service-item">
                                <input type="checkbox" name="service" value="plex" data-category="homelab" data-deps="">
                                <div class="service-card">
                                    <div class="service-name">Plex</div>
                                    <div class="service-description">Media server with transcoding</div>
                                    <div class="service-size">~800MB</div>
                                </div>
                            </label>
                            <label class="service-item">
                                <input type="checkbox" name="service" value="pihole" data-category="homelab" data-deps="">
                                <div class="service-card">
                                    <div class="service-name">Pi-hole</div>
                                    <div class="service-description">Network-wide ad blocking</div>
                                    <div class="service-size">~200MB</div>
                                </div>
                            </label>
                            <label class="service-item">
                                <input type="checkbox" name="service" value="homarr" data-category="homelab" data-deps="">
                                <div class="service-card">
                                    <div class="service-name">Homarr</div>
                                    <div class="service-description">Homelab dashboard</div>
                                    <div class="service-size">~150MB</div>
                                </div>
                            </label>
                            <label class="service-item">
                                <input type="checkbox" name="service" value="hoarder" data-category="homelab" data-deps="">
                                <div class="service-card">
                                    <div class="service-name">Hoarder</div>
                                    <div class="service-description">Bookmark manager</div>
                                    <div class="service-size">~100MB</div>
                                </div>
                            </label>
                        </div>
                    </div>

                    <div class="category" id="infrastructure-services">
                        <h3>üîß Infrastructure</h3>
                        <div class="service-list">
                            <label class="service-item">
                                <input type="checkbox" name="service" value="portainer" data-category="infrastructure" data-deps="docker-socket-proxy" checked>
                                <div class="service-card">
                                    <div class="service-name">Portainer</div>
                                    <div class="service-description">Container management UI</div>
                                    <div class="service-size">~300MB</div>
                                </div>
                            </label>
                            <label class="service-item">
                                <input type="checkbox" name="service" value="nginx" data-category="infrastructure" data-deps="" checked disabled>
                                <div class="service-card">
                                    <div class="service-name">Nginx (Required)</div>
                                    <div class="service-description">Reverse proxy with SSL</div>
                                    <div class="service-size">~50MB</div>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="step-actions">
                    <button class="btn btn-primary" onclick="app.nextStep()">Next: Select AI Models ‚Üí</button>
                </div>
            </section>

            <!-- Step 2: AI Model Selection -->
            <section id="step-models" class="step">
                <h2>Step 2: Select AI Models</h2>
                <p class="step-description">Choose Ollama models to pre-download (requires Ollama service)</p>

                <div id="models-disabled-notice" class="notice notice-warning" style="display:none;">
                    <strong>Note:</strong> AI model selection requires the Ollama service. Please go back and select Ollama in Step 1.
                </div>

                <div class="model-list">
                    <label class="model-item">
                        <input type="checkbox" name="model" value="qwen3:8b" data-size="4.7GB">
                        <div class="model-card">
                            <div class="model-name">Qwen3 8B</div>
                            <div class="model-description">Fast general-purpose model (8B parameters)</div>
                            <div class="model-size">~4.7GB</div>
                        </div>
                    </label>
                    <label class="model-item">
                        <input type="checkbox" name="model" value="qwen3-coder:30b" data-size="17GB">
                        <div class="model-card">
                            <div class="model-name">Qwen3 Coder 30B</div>
                            <div class="model-description">Code-specialized model (30B parameters)</div>
                            <div class="model-size">~17GB</div>
                        </div>
                    </label>
                    <label class="model-item">
                        <input type="checkbox" name="model" value="qwen3-vl:8b" data-size="5.5GB">
                        <div class="model-card">
                            <div class="model-name">Qwen3 VL 8B</div>
                            <div class="model-description">Vision-language multimodal model</div>
                            <div class="model-size">~5.5GB</div>
                        </div>
                    </label>
                    <label class="model-item">
                        <input type="checkbox" name="model" value="gpt-oss:20b" data-size="12GB">
                        <div class="model-card">
                            <div class="model-name">GPT-OSS 20B</div>
                            <div class="model-description">Open-source GPT-style model (20B parameters)</div>
                            <div class="model-size">~12GB</div>
                        </div>
                    </label>
                </div>

                <div class="step-actions">
                    <button class="btn btn-secondary" onclick="app.prevStep()">‚Üê Back</button>
                    <button class="btn btn-primary" onclick="app.nextStep()">Next: Configuration ‚Üí</button>
                </div>
            </section>

            <!-- Step 3: Configuration -->
            <section id="step-config" class="step">
                <h2>Step 3: Build Configuration</h2>
                <p class="step-description">Configure your ISO build options</p>

                <div class="config-form">
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="gpu-enabled" name="gpu_enabled">
                            Enable GPU Support (NVIDIA CUDA)
                        </label>
                        <p class="help-text">Enables GPU acceleration for Ollama and Plex transcoding</p>
                    </div>

                    <div class="form-group">
                        <label for="email">Email (optional)</label>
                        <input type="email" id="email" name="email" placeholder="your@email.com">
                        <p class="help-text">Receive a notification when your ISO is ready</p>
                    </div>

                    <div class="form-group">
                        <label for="iso-name">ISO Name</label>
                        <input type="text" id="iso-name" name="iso_name" value="ubuntu-24.04.3-homelab-custom" placeholder="ubuntu-24.04.3-homelab-custom">
                        <p class="help-text">Custom name for your ISO file</p>
                    </div>
                </div>

                <div class="build-summary">
                    <h3>Build Summary</h3>
                    <div class="summary-content">
                        <div class="summary-item">
                            <strong>Services:</strong>
                            <span id="summary-services">0 selected</span>
                        </div>
                        <div class="summary-item">
                            <strong>AI Models:</strong>
                            <span id="summary-models">0 selected</span>
                        </div>
                        <div class="summary-item">
                            <strong>Estimated ISO Size:</strong>
                            <span id="summary-size">~3.5GB</span>
                        </div>
                        <div class="summary-item">
                            <strong>Estimated Build Time:</strong>
                            <span id="summary-time">~45 minutes</span>
                        </div>
                    </div>
                </div>

                <div class="step-actions">
                    <button class="btn btn-secondary" onclick="app.prevStep()">‚Üê Back</button>
                    <button class="btn btn-success" onclick="app.startBuild()">üöÄ Start Build</button>
                </div>
            </section>

            <!-- Step 4: Build Progress -->
            <section id="step-progress" class="step">
                <h2>Building Your Custom ISO</h2>
                <p class="step-description">This may take 45-90 minutes depending on selected components</p>

                <!-- Sectioned Progress Bar (Domino's-style) -->
                <div class="pipeline-progress">
                    <div class="pipeline-stage" data-stage="queued">
                        <div class="stage-icon">üìã</div>
                        <div class="stage-name">Queued</div>
                        <div class="stage-status">pending</div>
                    </div>
                    <div class="pipeline-connector"></div>
                    <div class="pipeline-stage" data-stage="creating-vm">
                        <div class="stage-icon">üñ•Ô∏è</div>
                        <div class="stage-name">Creating VM</div>
                        <div class="stage-status">pending</div>
                    </div>
                    <div class="pipeline-connector"></div>
                    <div class="pipeline-stage" data-stage="downloading">
                        <div class="stage-icon">üì¶</div>
                        <div class="stage-name">Downloading</div>
                        <div class="stage-status">pending</div>
                    </div>
                    <div class="pipeline-connector"></div>
                    <div class="pipeline-stage" data-stage="building">
                        <div class="stage-icon">üî®</div>
                        <div class="stage-name">Building ISO</div>
                        <div class="stage-status">pending</div>
                    </div>
                    <div class="pipeline-connector"></div>
                    <div class="pipeline-stage" data-stage="uploading">
                        <div class="stage-icon">‚òÅÔ∏è</div>
                        <div class="stage-name">Uploading</div>
                        <div class="stage-status">pending</div>
                    </div>
                    <div class="pipeline-connector"></div>
                    <div class="pipeline-stage" data-stage="complete">
                        <div class="stage-icon">‚úÖ</div>
                        <div class="stage-name">Complete</div>
                        <div class="stage-status">pending</div>
                    </div>
                </div>

                <!-- Build Info -->
                <div class="build-info">
                    <div class="info-item">
                        <strong>Build ID:</strong>
                        <span id="build-id">-</span>
                    </div>
                    <div class="info-item">
                        <strong>VM Instance:</strong>
                        <span id="vm-name">-</span>
                    </div>
                    <div class="info-item">
                        <strong>Overall Progress:</strong>
                        <span id="overall-progress">0%</span>
                    </div>
                    <div class="info-item">
                        <strong>Estimated Completion:</strong>
                        <span id="estimated-completion">-</span>
                    </div>
                </div>

                <!-- Task Checklist -->
                <div class="task-checklist">
                    <h3>Build Tasks</h3>
                    <div class="checklist-container">
                        <div class="checklist-item" data-task="vm-creation">
                            <div class="task-checkbox">‚òê</div>
                            <div class="task-name">Creating build VM</div>
                            <div class="task-progress"></div>
                        </div>
                        <div class="checklist-item" data-task="cache-check">
                            <div class="task-checkbox">‚òê</div>
                            <div class="task-name">Checking GCS artifact cache</div>
                            <div class="task-progress"></div>
                        </div>
                        <div class="checklist-item" data-task="docker-images">
                            <div class="task-checkbox">‚òê</div>
                            <div class="task-name">Downloading Docker images</div>
                            <div class="task-progress"></div>
                        </div>
                        <div class="checklist-item" data-task="ollama-models">
                            <div class="task-checkbox">‚òê</div>
                            <div class="task-name">Downloading Ollama models</div>
                            <div class="task-progress"></div>
                        </div>
                        <div class="checklist-item" data-task="iso-build">
                            <div class="task-checkbox">‚òê</div>
                            <div class="task-name">Building custom ISO</div>
                            <div class="task-progress"></div>
                        </div>
                        <div class="checklist-item" data-task="iso-upload">
                            <div class="task-checkbox">‚òê</div>
                            <div class="task-name">Uploading ISO to storage</div>
                            <div class="task-progress"></div>
                        </div>
                        <div class="checklist-item" data-task="cache-populate">
                            <div class="task-checkbox">‚òê</div>
                            <div class="task-name">Populating artifact cache</div>
                            <div class="task-progress"></div>
                        </div>
                    </div>
                </div>

                <!-- Live Debug Log -->
                <div class="build-logs">
                    <div class="logs-header">
                        <h3>üìú Live Debug Log</h3>
                        <button id="copy-logs-btn" class="btn btn-small btn-secondary" onclick="app.copyLogs()" title="Copy logs to clipboard">
                            üìã Copy
                        </button>
                    </div>
                    <div id="log-container" class="log-container">
                        <div class="log-entry log-info">Waiting for build to start...</div>
                    </div>
                </div>
            </section>

            <!-- Step 5: Complete -->
            <section id="step-complete" class="step">
                <div class="completion-message">
                    <div class="completion-icon">‚úÖ</div>
                    <h2>Your ISO is Ready!</h2>
                    <p>Your custom homelab ISO has been built successfully.</p>
                </div>

                <div class="download-section">
                    <div class="download-info">
                        <div class="info-row">
                            <strong>Build ID:</strong>
                            <span id="complete-build-id">-</span>
                        </div>
                        <div class="info-row">
                            <strong>ISO Size:</strong>
                            <span id="complete-size">-</span>
                        </div>
                        <div class="info-row">
                            <strong>Build Time:</strong>
                            <span id="complete-time">-</span>
                        </div>
                        <div class="info-row">
                            <strong>Download Link Valid:</strong>
                            <span>7 days</span>
                        </div>
                    </div>

                    <div class="download-options">
                        <h3>What would you like to do?</h3>

                        <div class="option-cards">
                            <div class="option-card" onclick="app.showDownloadOption()">
                                <div class="option-icon">üì•</div>
                                <h4>Download ISO</h4>
                                <p>Download the ISO file to your computer</p>
                                <button class="btn btn-primary">Download</button>
                            </div>

                            <div class="option-card" onclick="app.showFlashOption()">
                                <div class="option-icon">üíæ</div>
                                <h4>Flash to USB Drive</h4>
                                <p>Create a bootable USB drive directly</p>
                                <button class="btn btn-primary">Flash USB</button>
                            </div>
                        </div>
                    </div>

                    <!-- Download Option Details (hidden by default) -->
                    <div id="download-details" class="option-details" style="display: none;">
                        <h4>üì• Download ISO File</h4>
                        <button class="btn btn-download btn-lg" onclick="app.downloadISO()">
                            üì• Download ISO
                        </button>
                        <p class="download-note">
                            Download link is valid for 7 days. The ISO will be automatically deleted after this period.
                        </p>
                    </div>

                    <!-- Flash Option Details (hidden by default) -->
                    <div id="flash-details" class="option-details" style="display: none;">
                        <h4>üíæ Flash to USB Drive</h4>
                        <p class="flash-intro">
                            Use our cross-platform CLI tool to create a bootable USB drive directly from this ISO.
                        </p>

                        <div class="flash-steps">
                            <div class="flash-step">
                                <div class="step-number">1</div>
                                <div class="step-content">
                                    <h5>Install Node.js</h5>
                                    <p>Required to run the USB flasher tool. Download from <a href="https://nodejs.org" target="_blank">nodejs.org</a></p>
                                </div>
                            </div>

                            <div class="flash-step">
                                <div class="step-number">2</div>
                                <div class="step-content">
                                    <h5>Run the Flasher Tool</h5>
                                    <p>Open your terminal and run this command:</p>
                                    <div class="code-block">
                                        <code id="flasher-command">npx homelab-iso-flasher --url="<span id="iso-url-placeholder">LOADING...</span>"</code>
                                        <button class="btn-copy" onclick="app.copyFlasherCommand()" title="Copy command">
                                            üìã
                                        </button>
                                    </div>
                                    <p class="code-note">The tool will guide you through selecting your USB drive</p>
                                </div>
                            </div>

                            <div class="flash-step">
                                <div class="step-number">3</div>
                                <div class="step-content">
                                    <h5>Follow the Interactive Prompts</h5>
                                    <p>The tool will:</p>
                                    <ul>
                                        <li>Download the ISO automatically</li>
                                        <li>Detect all connected USB drives</li>
                                        <li>Let you select the target drive</li>
                                        <li>Show progress during the write operation</li>
                                        <li>Verify the write and safely eject</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="flash-warning">
                            <strong>‚ö†Ô∏è Warning:</strong> Flashing will erase ALL data on the selected USB drive. Make sure to back up any important files first!
                        </div>

                        <div class="flash-alternatives">
                            <h5>Alternative Tools</h5>
                            <p>You can also use these popular tools to flash the ISO:</p>
                            <ul>
                                <li><strong>balenaEtcher</strong> (Windows, macOS, Linux): <a href="https://www.balena.io/etcher/" target="_blank">balena.io/etcher</a></li>
                                <li><strong>Rufus</strong> (Windows): <a href="https://rufus.ie/" target="_blank">rufus.ie</a></li>
                                <li><strong>dd command</strong> (Linux/macOS): <code>sudo dd if=file.iso of=/dev/sdX bs=4M status=progress</code></li>
                            </ul>
                        </div>

                        <button class="btn btn-secondary" onclick="app.hideOptionDetails()">‚Üê Back to Options</button>
                    </div>
                </div>

                <div class="next-steps">
                    <h3>After Creating Your Bootable USB</h3>
                    <ol>
                        <li>Boot your server from the USB drive</li>
                        <li>Install Ubuntu normally</li>
                        <li>After first boot, run: <code>cd /opt/homelab && ./post-install.sh</code></li>
                        <li>All services and models are pre-loaded and ready!</li>
                    </ol>
                </div>

                <div class="step-actions">
                    <button class="btn btn-secondary" onclick="app.reset()">‚Üê Build Another ISO</button>
                </div>
            </section>

            <!-- Error Display -->
            <section id="step-error" class="step">
                <div class="error-message">
                    <div class="error-icon">‚ùå</div>
                    <h2>Build Failed</h2>
                    <p id="error-text">An error occurred during the ISO build process.</p>
                </div>

                <div class="error-details">
                    <h3>Error Details</h3>
                    <pre id="error-details"></pre>
                </div>

                <div class="step-actions">
                    <button class="btn btn-secondary" onclick="app.reset()">‚Üê Try Again</button>
                </div>
            </section>
        </div>

        <footer>
            <p>
                <a href="https://github.com/brilliantsquirrel/Homelab-Install-Script" target="_blank">GitHub</a> |
                <a href="/api/docs" target="_blank">API Documentation</a> |
                <a href="https://docs.claude.com" target="_blank">Help</a>
            </p>
            <p class="footer-note">
                Built with ‚ù§Ô∏è for the homelab community
            </p>
        </footer>
    </div>

    <script src="js/api.js"></script>
    <script src="js/app.js"></script>
</body>
</html>
