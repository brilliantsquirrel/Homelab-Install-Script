<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Homelab ISO Builder</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>üè† Homelab ISO Builder</h1>
            <p class="tagline">Build your custom Ubuntu Server ISO with pre-configured homelab services</p>
        </header>

        <div id="app">
            <!-- Step 1: Service & Model Selection -->
            <section id="step-setup" class="step active">
                <h2>Step 1: Setup - Select Services & Models</h2>
                <p class="step-description">Choose which services and AI models to include in your homelab ISO</p>

                <!-- Services Section -->
                <div class="setup-section">
                    <h3>üì¶ Docker Services</h3>

                    <div class="category-group">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h4 style="margin: 0;">ü§ñ AI & Machine Learning</h4>
                            <button class="btn btn-small btn-secondary select-category-btn" data-category="ai">Select All</button>
                        </div>
                        <div class="service-checklist">
                            <label class="checklist-item">
                                <input type="checkbox" name="service" value="ollama" data-category="ai" data-size="2">
                                <span class="checkbox-custom"></span>
                                <div class="item-content">
                                    <span class="item-name">Ollama</span>
                                    <span class="item-description">Local LLM runtime with GPU support</span>
                                </div>
                                <span class="item-size">~2GB</span>
                            </label>
                            <label class="checklist-item">
                                <input type="checkbox" name="service" value="openwebui" data-category="ai" data-deps="ollama" data-size="0.5">
                                <span class="checkbox-custom"></span>
                                <div class="item-content">
                                    <span class="item-name">OpenWebUI</span>
                                    <span class="item-description">Web interface for Ollama</span>
                                </div>
                                <span class="item-size">~500MB</span>
                            </label>
                            <label class="checklist-item">
                                <input type="checkbox" name="service" value="langflow" data-category="ai" data-deps="ollama" data-size="1.5">
                                <span class="checkbox-custom"></span>
                                <div class="item-content">
                                    <span class="item-name">LangFlow</span>
                                    <span class="item-description">Visual AI workflow builder</span>
                                </div>
                                <span class="item-size">~1.5GB</span>
                            </label>
                            <label class="checklist-item">
                                <input type="checkbox" name="service" value="langgraph" data-category="ai" data-deps="ollama,langgraph-redis,langgraph-db" data-size="0.8">
                                <span class="checkbox-custom"></span>
                                <div class="item-content">
                                    <span class="item-name">LangGraph</span>
                                    <span class="item-description">Stateful agent workflow engine</span>
                                </div>
                                <span class="item-size">~800MB</span>
                            </label>
                            <label class="checklist-item">
                                <input type="checkbox" name="service" value="qdrant" data-category="ai" data-size="0.3">
                                <span class="checkbox-custom"></span>
                                <div class="item-content">
                                    <span class="item-name">Qdrant</span>
                                    <span class="item-description">Vector database for embeddings</span>
                                </div>
                                <span class="item-size">~300MB</span>
                            </label>
                            <label class="checklist-item">
                                <input type="checkbox" name="service" value="n8n" data-category="ai" data-deps="ollama" data-size="0.6">
                                <span class="checkbox-custom"></span>
                                <div class="item-content">
                                    <span class="item-name">n8n</span>
                                    <span class="item-description">Workflow automation platform</span>
                                </div>
                                <span class="item-size">~600MB</span>
                            </label>
                            <label class="checklist-item">
                                <input type="checkbox" name="service" value="comfyui" data-category="ai" data-size="3">
                                <span class="checkbox-custom"></span>
                                <div class="item-content">
                                    <span class="item-name">ComfyUI</span>
                                    <span class="item-description">Node-based UI for Stable Diffusion</span>
                                </div>
                                <span class="item-size">~3GB</span>
                            </label>
                            <label class="checklist-item">
                                <input type="checkbox" name="service" value="huggingface" data-category="ai" data-size="4">
                                <span class="checkbox-custom"></span>
                                <div class="item-content">
                                    <span class="item-name">HuggingFace TGI</span>
                                    <span class="item-description">Text Generation Inference server</span>
                                </div>
                                <span class="item-size">~4GB</span>
                            </label>
                        </div>
                    </div>

                    <div class="category-group">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h4 style="margin: 0;">üè° Homelab Services</h4>
                            <button class="btn btn-small btn-secondary select-category-btn" data-category="homelab">Select All</button>
                        </div>
                        <div class="service-checklist">
                            <label class="checklist-item">
                                <input type="checkbox" name="service" value="nextcloud" data-category="homelab" data-deps="nextcloud-db,nextcloud-redis" data-size="1.2">
                                <span class="checkbox-custom"></span>
                                <div class="item-content">
                                    <span class="item-name">Nextcloud</span>
                                    <span class="item-description">File storage & collaboration</span>
                                </div>
                                <span class="item-size">~1.2GB</span>
                            </label>
                            <label class="checklist-item">
                                <input type="checkbox" name="service" value="plex" data-category="homelab" data-size="0.8">
                                <span class="checkbox-custom"></span>
                                <div class="item-content">
                                    <span class="item-name">Plex</span>
                                    <span class="item-description">Media server with transcoding</span>
                                </div>
                                <span class="item-size">~800MB</span>
                            </label>
                            <label class="checklist-item">
                                <input type="checkbox" name="service" value="pihole" data-category="homelab" data-size="0.2">
                                <span class="checkbox-custom"></span>
                                <div class="item-content">
                                    <span class="item-name">Pi-hole</span>
                                    <span class="item-description">Network-wide ad blocking</span>
                                </div>
                                <span class="item-size">~200MB</span>
                            </label>
                            <label class="checklist-item">
                                <input type="checkbox" name="service" value="homarr" data-category="homelab" data-size="0.15">
                                <span class="checkbox-custom"></span>
                                <div class="item-content">
                                    <span class="item-name">Homarr</span>
                                    <span class="item-description">Homelab dashboard</span>
                                </div>
                                <span class="item-size">~150MB</span>
                            </label>
                            <label class="checklist-item">
                                <input type="checkbox" name="service" value="hoarder" data-category="homelab" data-size="0.1">
                                <span class="checkbox-custom"></span>
                                <div class="item-content">
                                    <span class="item-name">Hoarder</span>
                                    <span class="item-description">Bookmark manager</span>
                                </div>
                                <span class="item-size">~100MB</span>
                            </label>
                            <label class="checklist-item">
                                <input type="checkbox" name="service" value="code-server" data-category="homelab" data-size="0.25">
                                <span class="checkbox-custom"></span>
                                <div class="item-content">
                                    <span class="item-name">Code-Server</span>
                                    <span class="item-description">VS Code in the browser</span>
                                </div>
                                <span class="item-size">~250MB</span>
                            </label>
                        </div>
                    </div>

                    <div class="category-group">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h4 style="margin: 0;">üîß Infrastructure (Required)</h4>
                            <button class="btn btn-small btn-secondary select-category-btn" data-category="infrastructure">Select All</button>
                        </div>
                        <div class="service-checklist">
                            <label class="checklist-item">
                                <input type="checkbox" name="service" value="portainer" data-category="infrastructure" data-deps="docker-socket-proxy" data-size="0.3" checked>
                                <span class="checkbox-custom"></span>
                                <div class="item-content">
                                    <span class="item-name">Portainer</span>
                                    <span class="item-description">Container management UI</span>
                                </div>
                                <span class="item-size">~300MB</span>
                            </label>
                            <label class="checklist-item disabled">
                                <input type="checkbox" name="service" value="nginx" data-category="infrastructure" data-size="0.05" checked disabled>
                                <span class="checkbox-custom"></span>
                                <div class="item-content">
                                    <span class="item-name">Nginx (Required)</span>
                                    <span class="item-description">Reverse proxy with SSL</span>
                                </div>
                                <span class="item-size">~50MB</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- AI Models Section -->
                <div class="setup-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 style="margin: 0;">üß† AI Models (Ollama)</h3>
                        <button class="btn btn-small btn-secondary select-all-models-btn">Select All Models</button>
                    </div>
                    <div id="models-disabled-notice" class="notice notice-warning" style="display:none;">
                        <strong>Note:</strong> AI model selection requires the Ollama service. Please select Ollama above to enable this section.
                    </div>

                    <div class="model-checklist">
                        <label class="checklist-item">
                            <input type="checkbox" name="model" value="qwen3:8b" data-size="4.7">
                            <span class="checkbox-custom"></span>
                            <div class="item-content">
                                <span class="item-name">Qwen3 8B</span>
                                <span class="item-description">Fast general-purpose model (8B parameters)</span>
                            </div>
                            <span class="item-size">~4.7GB</span>
                        </label>
                        <label class="checklist-item">
                            <input type="checkbox" name="model" value="qwen3-coder:30b" data-size="17">
                            <span class="checkbox-custom"></span>
                            <div class="item-content">
                                <span class="item-name">Qwen3 Coder 30B</span>
                                <span class="item-description">Code-specialized model (30B parameters)</span>
                            </div>
                            <span class="item-size">~17GB</span>
                        </label>
                        <label class="checklist-item">
                            <input type="checkbox" name="model" value="qwen3-vl:8b" data-size="5.5">
                            <span class="checkbox-custom"></span>
                            <div class="item-content">
                                <span class="item-name">Qwen3 VL 8B</span>
                                <span class="item-description">Vision-language multimodal model</span>
                            </div>
                            <span class="item-size">~5.5GB</span>
                        </label>
                        <label class="checklist-item">
                            <input type="checkbox" name="model" value="gpt-oss:20b" data-size="12">
                            <span class="checkbox-custom"></span>
                            <div class="item-content">
                                <span class="item-name">GPT-OSS 20B</span>
                                <span class="item-description">Open-source GPT-style model (20B parameters)</span>
                            </div>
                            <span class="item-size">~12GB</span>
                        </label>
                    </div>
                </div>

                <!-- Build Configuration -->
                <div class="setup-section">
                    <h3>‚öôÔ∏è Configuration</h3>
                    <div class="config-form">
                        <div class="form-group">
                            <label class="checkbox-label" for="gpu-enabled">
                                <input type="checkbox" id="gpu-enabled" name="gpu_enabled">
                                <span class="checkbox-custom"></span>
                                <span>Enable GPU Support (NVIDIA CUDA)</span>
                            </label>
                            <p class="help-text">Enables GPU acceleration for Ollama and Plex transcoding</p>
                        </div>

                        <div class="form-group">
                            <label for="email">Email (optional)</label>
                            <input type="email" id="email" name="email" placeholder="your@email.com">
                            <p class="help-text">Receive a notification when your ISO is ready</p>
                        </div>

                        <div class="form-group" style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid #e0e0e0;">
                            <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">üíæ Previous Builds</label>
                            <p class="help-text" style="margin-bottom: 1rem;">Download a previously completed ISO build</p>
                            <div id="previous-builds-container">
                                <p style="color: #666; font-style: italic;">Loading previous builds...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Build Summary -->
                <div class="build-summary">
                    <h3>üìä Build Summary</h3>
                    <div class="summary-grid">
                        <div class="summary-item">
                            <div class="summary-label">Services</div>
                            <div class="summary-value" id="summary-services">0 selected</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">AI Models</div>
                            <div class="summary-value" id="summary-models">0 selected</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Estimated Size</div>
                            <div class="summary-value" id="summary-size">~3.5GB</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Build Time</div>
                            <div class="summary-value" id="summary-time">~45 min</div>
                        </div>
                    </div>
                </div>

                <div class="step-actions">
                    <button class="btn btn-success btn-lg" id="start-build-btn">üöÄ Start Build</button>
                </div>
            </section>

            <!-- Step 2: Build Progress -->
            <section id="step-progress" class="step">
                <h2>Step 2: Building Your Custom ISO</h2>
                <p class="step-description">This may take 45-90 minutes depending on selected components</p>

                <!-- Pipeline Progress -->
                <div class="pipeline-progress">
                    <div class="pipeline-stage" data-stage="queued">
                        <div class="stage-icon">üìã</div>
                        <div class="stage-name">Queued</div>
                        <div class="stage-status">pending</div>
                    </div>
                    <div class="pipeline-connector"></div>
                    <div class="pipeline-stage" data-stage="creating-vm">
                        <div class="stage-icon">üñ•Ô∏è</div>
                        <div class="stage-name">Creating VM</div>
                        <div class="stage-status">pending</div>
                    </div>
                    <div class="pipeline-connector"></div>
                    <div class="pipeline-stage" data-stage="downloading">
                        <div class="stage-icon">üì¶</div>
                        <div class="stage-name">Downloading</div>
                        <div class="stage-status">pending</div>
                    </div>
                    <div class="pipeline-connector"></div>
                    <div class="pipeline-stage" data-stage="building">
                        <div class="stage-icon">üî®</div>
                        <div class="stage-name">Building ISO</div>
                        <div class="stage-status">pending</div>
                    </div>
                    <div class="pipeline-connector"></div>
                    <div class="pipeline-stage" data-stage="uploading">
                        <div class="stage-icon">‚òÅÔ∏è</div>
                        <div class="stage-name">Uploading</div>
                        <div class="stage-status">pending</div>
                    </div>
                    <div class="pipeline-connector"></div>
                    <div class="pipeline-stage" data-stage="complete">
                        <div class="stage-icon">‚úÖ</div>
                        <div class="stage-name">Complete</div>
                        <div class="stage-status">pending</div>
                    </div>
                </div>

                <!-- Build Info -->
                <div class="build-info">
                    <div class="info-item">
                        <strong>Build ID:</strong>
                        <span id="build-id">-</span>
                    </div>
                    <div class="info-item">
                        <strong>VM Instance:</strong>
                        <span id="vm-name">-</span>
                    </div>
                    <div class="info-item">
                        <strong>Overall Progress:</strong>
                        <span id="overall-progress">0%</span>
                    </div>
                    <div class="info-item">
                        <strong>Estimated Completion:</strong>
                        <span id="estimated-completion">-</span>
                    </div>
                </div>

                <!-- Task Checklist -->
                <div class="task-checklist">
                    <h3>Build Tasks</h3>
                    <div class="checklist-container">
                        <div class="checklist-item" data-task="vm-creation">
                            <div class="task-checkbox">‚òê</div>
                            <div class="task-name">Creating build VM</div>
                            <div class="task-progress"></div>
                        </div>
                        <div class="checklist-item" data-task="cache-check">
                            <div class="task-checkbox">‚òê</div>
                            <div class="task-name">Checking GCS artifact cache</div>
                            <div class="task-progress"></div>
                        </div>
                        <div class="checklist-item" data-task="docker-images">
                            <div class="task-checkbox">‚òê</div>
                            <div class="task-name">Downloading Docker images</div>
                            <div class="task-progress"></div>
                        </div>
                        <div class="checklist-item" data-task="ollama-models">
                            <div class="task-checkbox">‚òê</div>
                            <div class="task-name">Downloading Ollama models</div>
                            <div class="task-progress"></div>
                        </div>
                        <div class="checklist-item" data-task="iso-build">
                            <div class="task-checkbox">‚òê</div>
                            <div class="task-name">Building custom ISO</div>
                            <div class="task-progress"></div>
                        </div>
                        <div class="checklist-item" data-task="iso-upload">
                            <div class="task-checkbox">‚òê</div>
                            <div class="task-name">Uploading ISO to storage</div>
                            <div class="task-progress"></div>
                        </div>
                        <div class="checklist-item" data-task="cache-populate">
                            <div class="task-checkbox">‚òê</div>
                            <div class="task-name">Populating artifact cache</div>
                            <div class="task-progress"></div>
                        </div>
                    </div>
                </div>

                <!-- Live Debug Log -->
                <div class="build-logs">
                    <div class="logs-header">
                        <h3>üìú Live Debug Log</h3>
                        <button id="copy-logs-btn" class="btn btn-small btn-secondary" title="Copy logs to clipboard">
                            üìã Copy
                        </button>
                    </div>
                    <div id="log-container" class="log-container">
                        <div class="log-entry log-info">Waiting for build to start...</div>
                    </div>
                </div>
            </section>

            <!-- Step 3: Flash to USB Drive -->
            <section id="step-flash" class="step">
                <h2>Step 3: Create Bootable USB Drive</h2>
                <p class="step-description">Write the ISO directly to a USB flash drive</p>

                <div class="completion-message">
                    <div class="completion-icon">‚úÖ</div>
                    <h3>Your ISO is Ready!</h3>
                    <p>Build ID: <strong id="flash-build-id">-</strong></p>
                    <p>Size: <strong id="flash-iso-size">-</strong></p>
                </div>

                <!-- USB Device Detection -->
                <div class="usb-section">
                    <div class="section-header">
                        <h3>üíæ Select USB Drive</h3>
                        <button class="btn btn-small btn-secondary" id="refresh-usb-btn">
                            üîÑ Refresh Devices
                        </button>
                    </div>

                    <div id="usb-scanning" class="notice notice-info" style="display:none;">
                        <strong>Scanning for USB devices...</strong>
                    </div>

                    <div id="usb-devices-list" class="usb-devices-list">
                        <div class="notice notice-warning">
                            <strong>No USB devices detected.</strong> Please insert a USB drive and click "Refresh Devices".
                        </div>
                    </div>

                    <div class="usb-requirements">
                        <h4>Requirements</h4>
                        <ul>
                            <li>USB drive capacity: <strong id="required-capacity">64GB+</strong> (ISO size: <span id="iso-size-display">-</span>)</li>
                            <li>All data on the selected drive will be erased</li>
                            <li>Drive will be formatted and made bootable</li>
                        </ul>
                    </div>
                </div>

                <!-- Flash Progress -->
                <div id="flash-progress-section" class="flash-progress-section" style="display:none;">
                    <h3>‚ö° Flashing Progress</h3>

                    <div class="flash-stages">
                        <div class="flash-stage" data-stage="download">
                            <div class="stage-status">‚è≥</div>
                            <div class="stage-info">
                                <div class="stage-name">Downloading ISO</div>
                                <div class="stage-progress">
                                    <div class="progress-bar">
                                        <div class="progress-fill" id="download-progress" style="width: 0%"></div>
                                    </div>
                                    <div class="progress-text" id="download-text">Waiting...</div>
                                </div>
                            </div>
                        </div>

                        <div class="flash-stage" data-stage="unmount">
                            <div class="stage-status">‚è≥</div>
                            <div class="stage-info">
                                <div class="stage-name">Unmounting Drive</div>
                                <div class="stage-progress">
                                    <div class="progress-text" id="unmount-text">Waiting...</div>
                                </div>
                            </div>
                        </div>

                        <div class="flash-stage" data-stage="write">
                            <div class="stage-status">‚è≥</div>
                            <div class="stage-info">
                                <div class="stage-name">Writing ISO to USB</div>
                                <div class="stage-progress">
                                    <div class="progress-bar">
                                        <div class="progress-fill" id="write-progress" style="width: 0%"></div>
                                    </div>
                                    <div class="progress-text" id="write-text">Waiting...</div>
                                </div>
                            </div>
                        </div>

                        <div class="flash-stage" data-stage="verify">
                            <div class="stage-status">‚è≥</div>
                            <div class="stage-info">
                                <div class="stage-name">Verifying Write</div>
                                <div class="stage-progress">
                                    <div class="progress-bar">
                                        <div class="progress-fill" id="verify-progress" style="width: 0%"></div>
                                    </div>
                                    <div class="progress-text" id="verify-text">Waiting...</div>
                                </div>
                            </div>
                        </div>

                        <div class="flash-stage" data-stage="eject">
                            <div class="stage-status">‚è≥</div>
                            <div class="stage-info">
                                <div class="stage-name">Ejecting Drive</div>
                                <div class="stage-progress">
                                    <div class="progress-text" id="eject-text">Waiting...</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="flash-log">
                        <h4>Flash Log</h4>
                        <div id="flash-log-container" class="log-container"></div>
                    </div>
                </div>

                <!-- Flash Complete -->
                <div id="flash-complete-section" class="flash-complete-section" style="display:none;">
                    <div class="success-message">
                        <div class="success-icon">‚úÖ</div>
                        <h3>USB Drive Ready!</h3>
                        <p>Your bootable USB drive has been created successfully.</p>
                    </div>

                    <div class="next-steps">
                        <h4>Next Steps</h4>
                        <ol>
                            <li>Safely remove the USB drive from your computer</li>
                            <li>Insert it into your target server (Dell R630)</li>
                            <li>Boot from the USB drive (press F11 or F12 during startup)</li>
                            <li>Follow the Ubuntu installation wizard</li>
                            <li>After first boot, your homelab services will auto-start!</li>
                        </ol>
                    </div>
                </div>

                <div class="step-actions">
                    <button class="btn btn-secondary" id="skip-flash-btn">‚è≠Ô∏è Skip - Download ISO Instead</button>
                    <button id="start-flash-btn" class="btn btn-primary" disabled>
                        ‚ö° Flash to USB Drive
                    </button>
                </div>
            </section>

            <!-- Error Display -->
            <section id="step-error" class="step">
                <div class="error-message">
                    <div class="error-icon">‚ùå</div>
                    <h2>Build Failed</h2>
                    <p id="error-text">An error occurred during the ISO build process.</p>
                </div>

                <div class="error-details">
                    <h3>Error Details</h3>
                    <pre id="error-details"></pre>
                </div>

                <div class="step-actions">
                    <button class="btn btn-secondary" id="reset-btn">‚Üê Try Again</button>
                </div>
            </section>
        </div>

        <footer>
            <p>
                <a href="https://github.com/brilliantsquirrel/Homelab-Install-Script" target="_blank">GitHub</a> |
                <a href="/api/docs" target="_blank">API Documentation</a>
            </p>
            <p class="footer-note">
                Built with ‚ù§Ô∏è for the homelab community
            </p>
        </footer>
    </div>

    <script src="js/api.js"></script>
    <script src="js/app.js"></script>
</body>
</html>
